services:  
  # Container now based on nginx-proxy
  nginx:
    profiles:
      - live
    image: nginxproxy/nginx-proxy:1.5
    container_name: dean-nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./conf/live/app.conf:/etc/nginx/conf.d/app.conf:ro
      - ${CERTS:-./mounts/certs}:/etc/nginx/certs:ro
    restart: unless-stopped

  # Trying to connect nginx-proxy/acme-companion
  nginx-dev:
    profiles:
      - certs
      - dev
    image: nginxproxy/nginx-proxy:1.5
    container_name: dean-nginx-dev
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./conf/live/app.conf:/etc/nginx/conf.d/app.conf:ro

      - ./mounts/vhost:/etc/nginx/vhost.d
      - ./mounts/html:/usr/share/nginx/html

      - ${CERTS:-./mounts/certs}:/etc/nginx/certs:ro
    restart: unless-stopped
    # environment:
    #   - DEFAULT_ROOT=301 https://google.com   # Not working?

  acme:
    container_name: nginx-acme
    image: nginxproxy/acme-companion
    profiles: 
      - certs
    volumes_from:
      - nginx-dev
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./mounts/acme:/etc/acme.sh 
      - ${CERTS_DEV:-./mounts/certs}:/etc/nginx/certs
    environment:
      - DEFAULT_EMAIL=${EMAIL?}

    

  # Legacy version - Manual nginx configuration
  nginx-legacy: 
    profiles:
      - legacy
    container_name: dean-nginx-legacy
    image: nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./conf/legacy:/etc/nginx/conf.d:ro
      - ${CERTS_LEGACY:-./certs/}:/etc/nginx/ssl:ro